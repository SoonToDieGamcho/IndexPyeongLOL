<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>지령 생성기</title>
  
  <link rel="icon" href="images/fv.png" type="image/png">
  
  <link href="https://fonts.googleapis.com/css2?family=Nanum+Myeongjo&display=swap" rel="stylesheet" />
  <style>
    body {
      background: #2c2c2c url("images/bg.png") no-repeat center center fixed;
      background-size: cover;
      color: #fff;
      font-family: "Nanum Myeongjo", serif;
      display: flex;
      justify-content: center;
      align-items: center;
      height: 100vh;
      margin: 0;
      overflow: hidden;
    }

    .wrapper {
      width: 800px;
      height: 600px;
      position: relative;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      overflow: hidden;
    }

    .paper {
      background: url("images/paper.png") no-repeat center/contain;
      width: 410px;
      height: 100px;
      font-size: 12px;
      font-weight: bold;
      text-align: center;
      color: #000;
      white-space: pre-wrap;
      display: flex;
      align-items: center;
      justify-content: center;
      transform: translateY(-300px);
      opacity: 0;
      transition: transform 0.8s ease-out, opacity 0.8s ease-out;
      padding: 20px;
      box-sizing: border-box;
    }

    .paper.show {
      transform: translateY(0);
      opacity: 1;
    }

    .paper.hide {
      transform: translateY(-300px);
      opacity: 0;
    }

    .button {
      background: url("images/button.png") no-repeat center/contain;
      width: 400px;
      height: 180px;
      border: none;
      cursor: pointer;
      margin-top: 40px;
    }

    .button:active {
      transform: scale(0.95);
    }
  </style>
</head>
<body>
  <div class="wrapper">
    <div class="paper" id="command"></div>
    <button class="button" onclick="roll()"></button>
  </div>

  <script src="vocabulary.js"></script>

  <script>
    const paper = document.getElementById("command");
    let isShowing = false;

    // --- 유틸리티 함수 ---
    function maybe(item, chance = 0.7) { return Math.random() < chance ? item : ""; }
    function random(arr) { return arr[Math.floor(Math.random() * arr.length)]; }
    function randomInt(min, max) { return Math.floor(Math.random() * (max - min + 1)) + min; }

    function generateRandomCount() {
      const r = Math.random();
      let num;
      if (r < 0.50) num = randomInt(1, 10);
      else if (r < 0.80) num = randomInt(11, 100);
      else if (r < 0.90) num = randomInt(101, 1000);
      else if (r < 0.97) num = randomInt(1001, 10000);
      else num = randomInt(10001, 10000000);
      return num.toLocaleString() + "번";
    }

    function getFrequencyPhrase() {
      let phrase = generateRandomCount();
      if (Math.random() < 0.3) { phrase += " " + random(countSuffixes); }
      return phrase;
    }

    function getParticle(word, type = "object") {
      word = word.trim();
      if (type === "location") return word + "에서";
      const lastChar = word[word.length - 1];
      const uni = lastChar.charCodeAt(0);
      const isBatchim = (uni - 0xAC00) % 28 !== 0;
      return word + (type === "with" ? (isBatchim ? "과" : "와") : (isBatchim ? "을" : "를"));
    }

    function insertLineBreaks(text, maxLength = 26) {
      let result = "";
      let currentLineLength = 0;
      for (let i = 0; i < text.length; i++) {
        const char = text[i];
        if (char === "\n") { currentLineLength = 0; } 
        else { currentLineLength++; }
        result += char;
        if (currentLineLength >= maxLength) {
          result += "\n";
          currentLineLength = 0;
        }
      }
      return result;
    }

    // --- 패턴별 생성 로직 ---

    // 패턴 A: 시간형
    function generateTimeCommand() {
      return `${random(timeNouns)}에 ${random(timeVerbs)}`;
    }

    // 패턴 B: 장소형
    function generateLocationCommand() {
      const preMod = maybe(random(preModifiers), 0.25);
      const modifier = maybe(random(locationModifiers), 0.35);
      const loc = random(locationNouns);
      const verb = random(locationVerbs);
      
      return [preMod, modifier, getParticle(loc, "location"), verb].filter(Boolean).join(" ");
    }

    // 패턴 C: 범용 상호형
    function generateUniversalCommand() {
      const preMod = maybe(random(preModifiers), 0.2);
      
      // 장소 구문 생성 (25% 확률)
      let locationPhrase = "";
      if (Math.random() < 0.25) {
        const locMod = maybe(random(locationModifiers), 0.35);
        const locNoun = random(locationNouns);
        locationPhrase = `${locMod} ${getParticle(locNoun, "location")}`.trim();
      }

      const omitModifiers = Math.random() < 0.15;
      const objectModifier = omitModifiers ? "" : maybe(random(objectModifiers), 0.35);
      const nounSource = !objectModifier ? specialObjects : objects;
      const objectWithParticle = getParticle(random(nounSource).trim(), Math.random() < 0.5 ? "with" : "object");
      
      const freqPhrase = maybe(getFrequencyPhrase(), 0.15);
      const adverb = omitModifiers ? "" : maybe(random(adverbs), 0.35);

      let verb = (objectWithParticle.endsWith("과") || objectWithParticle.endsWith("와")) 
        ? random(withVerbs) 
        : (adverb || freqPhrase ? random(verbs) : random(specialVerbs));

      return [preMod, locationPhrase, objectWithParticle, adverb, freqPhrase, verb].filter(Boolean).join(" ");
    }

    // 패턴 D: 간단 동작형
    function generateSimpleCommand() {
      const preMod = maybe(random(preModifiers), 0.25);
      const freqPhrase = maybe(getFrequencyPhrase(), 0.3);
      const adverb = random(adverbs);
      const verb = random(simpleVerbs);
      return [preMod, adverb, freqPhrase, verb].filter(Boolean).join(" ");
    }

    function addDuration(command, chance = 0.15) {
      if (Math.random() < chance) { return command + "\n" + random(durationPhrases); }
      return command;
    }

    // --- 메인 컨트롤러 ---
    function generateCommand() {
      const rand = Math.random();
      let cmd = "";
      
      if (rand < 0.15) return generateTimeCommand();          
      else if (rand < 0.30) cmd = generateLocationCommand();  
      else if (rand < 0.50) cmd = generateSimpleCommand();    
      else cmd = generateUniversalCommand();                  

      return addDuration(cmd, 0.15);
    }

    function roll() {
      const isEasterEgg = Math.random() < 0.02;
      if (isShowing) {
        paper.classList.remove("show");
        paper.classList.add("hide");
        setTimeout(() => { updatePaper(isEasterEgg); paper.classList.remove("hide"); paper.classList.add("show"); }, 800);
      } else {
        updatePaper(isEasterEgg);
        paper.classList.add("show");
        isShowing = true;
      }
    }

    function updatePaper(isEasterEgg) {
      if (isEasterEgg) {
        const egg = random(easterEggs);
        paper.style.background = `url("${egg.image}") no-repeat center/contain`;
        paper.innerText = egg.text;
      } else {
        paper.style.background = 'url("images/paper.png") no-repeat center/contain';
        paper.innerText = insertLineBreaks(generateCommand(), 26);
      }
    }
  </script>
</body>
</html>
